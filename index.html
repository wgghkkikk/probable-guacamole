<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù…Ù„ÙƒØ© Ø¹Ù„ÙˆØ´ - Ù†Øµ Ø§Ù„Ø­Ø±ÙŠØ© ğŸ‘‘</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <style>
        :root { --main: #ffd700; --bg: #000; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø± */
        #master-layout { 
            display: flex; 
            flex-direction: row; 
            flex: 1; 
            gap: 10px; 
            padding: 10px;
            overflow: hidden;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ (Ø§Ù„Ø£Ù„ÙˆØ§Ø­) */
        .panel { 
            background: #0a0a0a; 
            border: 2px solid #222; 
            border-radius: 15px; 
            display: flex; 
            flex-direction: column; 
            transition: border 0.3s, box-shadow 0.3s;
        }
        .panel:hover { border-color: var(--main); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1); }

        /* Ù…Ù‚Ø¨Ø¶ Ø§Ù„Ø³Ø­Ø¨ */
        .drag-handle { 
            background: #111; 
            padding: 8px; 
            cursor: move; 
            text-align: center; 
            font-size: 11px; 
            color: var(--main); 
            border-bottom: 1px solid #222;
            border-radius: 13px 13px 0 0;
            font-weight: bold;
        }

        #sidebar { width: 220px; flex-shrink: 0; }
        #main-chat-area { flex-grow: 1; }

        /* Ø§Ù„Ù…Ø§ÙŠÙƒØ§Øª */
        .mics-row { display: flex; gap: 5px; padding: 10px; background: #0f0f0f; border-bottom: 1px solid #222; }
        .mic-slot { flex: 1; background: #1a1a1a; height: 55px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; border: 1px dashed #444; position: relative; }
        .mic-slot.occupied { border: 1px solid var(--main); background: #222; }

        /* Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ */
        #yt-box { padding: 10px; background: #0f0f0f; border-bottom: 1px solid #222; }
        #video-screen { display: none; height: 220px; background: #000; margin-top: 10px; border-radius: 10px; overflow: hidden; border: 1px solid var(--main); }

        /* Ø§Ù„Ø´Ø§Øª */
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #050505; }
        .msg { padding: 12px; border-radius: 15px; max-width: 80%; line-height: 1.5; position: relative; }
        .msg.me { align-self: flex-end; background: #1a1a1a; border-right: 4px solid var(--main); }
        .msg.other { align-self: flex-start; background: #111; border-left: 4px solid #fff; }
        .msg.bot { align-self: center; background: rgba(0, 242, 255, 0.1); border: 1px solid #00f2ff; color: #00f2ff; text-align: center; width: 90%; font-weight: bold; }

        .typing-area { padding: 15px; background: #0a0a0a; display: flex; gap: 10px; border-top: 1px solid #222; }
        input[type="text"] { flex: 1; background: #000; border: 1px solid #333; color: #fff; padding: 12px 20px; border-radius: 30px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: var(--main); }
        
        button.send-btn { background: var(--main); color: #000; border: none; padding: 10px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; }

        /* Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .bot-user { background: linear-gradient(90deg, #000, #004444); border: 1px solid #00f2ff; border-radius: 10px; padding: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    </style>
</head>
<body>

    <div id="master-layout">
        <div id="sidebar" class="panel">
            <div class="drag-handle">âœ¥ Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© âœ¥</div>
            <div style="padding: 15px; overflow-y: auto;">
                <h4 style="color: var(--main); text-align: center; margin-top: 0;">Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† ğŸ‡®ğŸ‡¶</h4>
                <div id="users-container">
                    </div>
            </div>
        </div>

        <div id="main-chat-area" class="panel">
            <div class="drag-handle">âœ¥ Ø§Ø³Ø­Ø¨ Ù„ØªØ­Ø±ÙŠÙƒ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© âœ¥</div>
            
            <div class="mics-row">
                <div class="mic-slot" id="mic1">ğŸ™ï¸ Ø®Ø§Ù„ÙŠ <button onclick="handleMic(1)" style="font-size:9px; margin-top:4px;">ØµØ¹ÙˆØ¯</button></div>
                <div class="mic-slot" id="mic2">ğŸ™ï¸ Ø®Ø§Ù„ÙŠ <button onclick="handleMic(2)" style="font-size:9px; margin-top:4px;">ØµØ¹ÙˆØ¯</button></div>
                <div class="mic-slot" id="mic3">ğŸ™ï¸ Ø®Ø§Ù„ÙŠ <button onclick="handleMic(3)" style="font-size:9px; margin-top:4px;">ØµØ¹ÙˆØ¯</button></div>
                <div class="mic-slot" id="mic4">ğŸ™ï¸ Ø®Ø§Ù„ÙŠ <button onclick="handleMic(4)" style="font-size:9px; margin-top:4px;">ØµØ¹ÙˆØ¯</button></div>
            </div>

            <div id="yt-box">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="yt-search" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨..." style="flex:1; background:#000; border:1px solid #333; color:#fff; padding:8px; border-radius:5px;">
                    <button onclick="doSearch()" style="background:var(--main); border:none; padding:0 15px; border-radius:5px; cursor:pointer;">ğŸ”</button>
                </div>
                <div id="yt-results" style="display: flex; overflow-x: auto; gap: 10px; margin-top: 8px;"></div>
                <div id="video-screen"></div>
            </div>

            <div id="chat-window"></div>

            <div class="typing-area">
                <input type="text" id="msgInput" placeholder="ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø¹Ù„ÙˆØ´...">
                <button class="send-btn" onclick="postMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

<script>
    const YT_KEY = "AIzaSyC4wFkLrA_BlNzreseXQLeSp_40Gbmu9VU"; 
    const firebaseConfig = {
        apiKey: "AIzaSyDpjqkb4U-RF71r_Zv3tHAV9wWWe2L3pEQ",
        authDomain: "masterchat-f2da9.firebaseapp.com",
        databaseURL: "https://masterchat-f2da9-default-rtdb.firebaseio.com",
        projectId: "masterchat-f2da9"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    let myIdentity = "";

    // ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… "Ø§Ù„Ø­Ø±ÙŠØ©": Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ø­
    new Sortable(document.getElementById('master-layout'), {
        handle: '.drag-handle',
        animation: 200,
        ghostClass: 'sortable-ghost'
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            myIdentity = user.email === "rgrghh77@gmail.com" ? "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± Ø¹Ù„ÙˆØ´ ğŸ‘‘" : user.email.split('@')[0];
            db.ref('status/' + user.uid).set({ n: myIdentity });
            db.ref('status/' + user.uid).onDisconnect().remove();
            startSystem();
        } else { window.location.href = "index.html"; }
    });

    function startSystem() {
        loadMessages();
        loadActiveUsers();
        syncAudioSlots();
        syncYouTube();
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ ---
    function botLogic(text) {
        const t = text.toLowerCase();
        if(t === "Ø¨ÙˆØª") replyBot("Ù†Ø¹Ù… ÙŠØ§ Ù…Ù„Ùƒ Ø¹Ù„ÙˆØ´ØŒ Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©! ğŸ›¡ï¸");
        if(t.includes("Ø¹Ù„ÙˆØ´")) replyBot("Ø¹Ù„ÙˆØ´ Ù‡Ùˆ ÙØ®Ø± Ø§Ù„Ù…Ù…Ù„ÙƒØ© ÙˆØ§Ù„Ø¢Ù…Ø± Ø§Ù„Ù†Ø§Ù‡ÙŠ ğŸ‘‘");
    }

    function replyBot(msg) {
        db.ref('msgs').push({ u: "Ø¨ÙˆØª Ø§Ù„Ù…Ù…Ù„ÙƒØ© ğŸ¤–", t: msg, type: 'bot' });
    }

    // --- ÙŠÙˆØªÙŠÙˆØ¨ ---
    async function doSearch() {
        const q = document.getElementById('yt-search').value;
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&type=video&maxResults=5&key=${YT_KEY}`);
        const data = await res.json();
        const resDiv = document.getElementById('yt-results');
        resDiv.innerHTML = '';
        data.items.forEach(v => {
            resDiv.innerHTML += `
                <div onclick="startStream('${v.id.videoId}')" style="cursor:pointer; min-width:90px; text-align:center;">
                    <img src="${v.snippet.thumbnails.default.url}" width="90" style="border-radius:5px;">
                    <p style="font-size:8px; margin:3px; color:#ccc;">${v.snippet.title.substring(0,15)}</p>
                </div>`;
        });
    }

    function startStream(id) { db.ref('live').set({ id: id, on: true }); }
    function syncYouTube() {
        db.ref('live').on('value', snap => {
            const v = snap.val();
            const screen = document.getElementById('video-screen');
            if(v && v.on) {
                screen.style.display = 'block';
                screen.innerHTML = `<iframe width="100%" height="100%" src="https://www.youtube.com/embed/${v.id}?autoplay=1" frameborder="0" allowfullscreen></iframe>`;
            } else { screen.style.display = 'none'; }
        });
    }

    // --- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
    function postMessage() {
        const inp = document.getElementById('msgInput');
        if(!inp.value.trim()) return;
        const isMe = myIdentity.includes("Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±");
        db.ref('msgs').push({ u: myIdentity, t: inp.value, m: isMe });
        botLogic(inp.value);
        inp.value = '';
    }

    function loadMessages() {
        db.ref('msgs').limitToLast(30).on('child_added', snap => {
            const d = snap.val();
            const win = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `msg ${d.type === 'bot' ? 'bot' : (d.m ? 'me' : 'other')}`;
            div.innerHTML = `<small style="color:var(--main); display:block; margin-bottom:4px;">${d.u}</small>${d.t}`;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
        });
        db.ref('msgs').on('child_removed', () => location.reload());
    }

    // --- Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† ÙˆØ§Ù„Ù…Ø§ÙŠÙƒØ§Øª ---
    function loadActiveUsers() {
        db.ref('status').on('value', snap => {
            const cont = document.getElementById('users-container');
            cont.innerHTML = `
                <div class="bot-user">
                    <div style="width:10px; height:10px; background:#00f2ff; border-radius:50%; box-shadow:0 0 5px #00f2ff;"></div>
                    <span style="color:#00f2ff; font-weight:bold; font-size:13px;">Ø¨ÙˆØª Ø§Ù„Ù…Ù…Ù„ÙƒØ© ğŸ¤–</span>
                </div>`;
            snap.forEach(u => {
                cont.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid #111; display:flex; align-items:center; gap:10px;">
                        <div style="width:8px; height:8px; background:#00ff00; border-radius:50%;"></div>
                        <span style="font-size:13px;">${u.val().n}</span>
                    </div>`;
            });
        });
    }

    function handleMic(n) {
        const ref = db.ref('mics/slot' + n);
        ref.once('value', s => {
            if(s.val() && s.val().u === myIdentity) ref.remove();
            else if(!s.val()) ref.set({ u: myIdentity });
        });
    }

    function syncAudioSlots() {
        for(let i=1; i<=4; i++) {
            db.ref('mics/slot' + i).on('value', s => {
                const el = document.getElementById('mic' + i);
                if(s.val()) {
                    el.className = "mic-slot occupied";
                    el.innerHTML = `<span style="color:var(--main); font-weight:bold;">ğŸ¤ ${s.val().u}</span><button onclick="handleMic(${i})" style="font-size:8px;">Ù†Ø²ÙˆÙ„</button>`;
                } else {
                    el.className = "mic-slot";
                    el.innerHTML = `ğŸ™ï¸ Ø®Ø§Ù„ÙŠ <button onclick="handleMic(${i})" style="font-size:9px; margin-top:4px;">ØµØ¹ÙˆØ¯</button>`;
                }
            });
        }
    }
</script>
</body>
</html>
