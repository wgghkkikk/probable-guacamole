<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù…Ù…Ù„ÙƒØ© Ø¹Ù„ÙˆØ´ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© ğŸ‘‘</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --gold: #ffd700; --bg: #000; --vip: #00d4ff; --msg-me: #222; --msg-other: #111; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #fff; font-family: sans-serif; overflow: hidden; }
        
        /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
        #star-bg { position: fixed; width: 100%; height: 100%; z-index: -1; background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); overflow: hidden; }
        
        .app { display: flex; flex-direction: column; height: 100vh; position: relative; z-index: 1; }
        .header { height: 70px; background: rgba(10, 10, 10, 0.9); border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        
        #chat-win { flex: 1; overflow-y: auto; padding: 10px 15px 170px 15px; display: flex; flex-direction: column; gap: 15px; }
        .bubble { max-width: 80%; padding: 10px; border-radius: 15px; position: relative; border: 1px solid #333; transition: 0.3s; }
        .msg-me { align-self: flex-end; background: var(--msg-me); border-right: 4px solid var(--gold); }
        .msg-other { align-self: flex-start; background: var(--msg-other); border-left: 4px solid #555; }
        
        .level-badge { font-size: 9px; background: var(--gold); color: #000; padding: 1px 5px; border-radius: 10px; margin-right: 5px; font-weight: bold; }
        .time { font-size: 8px; opacity: 0.5; margin-top: 5px; display: block; }

        .input-box { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(10,10,10,0.95); border-top: 1px solid #333; padding: 10px; z-index: 2000; }
        .footer { display: flex; align-items: center; gap: 8px; }
        #mInp { flex: 1; background: #1a1a1a; border: 1px solid #444; color: #fff; border-radius: 20px; padding: 10px 15px; height: 45px; }
        
        .btn-icon { background: none; border: none; color: var(--gold); font-size: 24px; cursor: pointer; }
        .send-btn { background: var(--gold); color: #000; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; border: none; }

        .notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--gold); color: #000; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 5000; display: none; animation: slideDown 0.5s; }
        @keyframes slideDown { from { top: -50px; } to { top: 80px; } }

        .menu { position: fixed; top: 0; width: 80%; height: 100%; background: #0a0a0a; z-index: 3000; border: 1px solid var(--gold); display: none; padding: 20px; }
        .show { display: block; }
        
        #ban-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; color: red; }
    </style>
</head>
<body>

<div id="star-bg"></div>
<div id="ban-screen"><h1>ğŸš« Ù…Ø·Ø±ÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ù…Ù„ÙƒØ©</h1><p>ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p></div>
<div id="notify" class="notification"></div>

<div class="app">
    <div class="header">
        <button class="btn-icon" id="setBtn">âš™ï¸</button>
        <div style="text-align:center;">
            <b style="color:var(--gold)">Ù…Ù…Ù„ÙƒØ© Ø¹Ù„ÙˆØ´ ğŸ‘‘</b><br>
            <span id="typing-st" style="font-size:10px; color:#aaa;"></span>
        </div>
        <button class="btn-icon" onclick="openR()">ğŸ‘¥</button>
    </div>

    <div id="chat-win"></div>

    <div class="input-box">
        <div class="footer">
            <button class="btn-icon" onclick="document.getElementById('imgF').click()">ğŸ–¼ï¸</button>
            <button class="btn-icon" id="voiceBtn">ğŸ¤</button>
            <input type="file" id="imgF" hidden onchange="sendImg(this)">
            <input type="text" id="mInp" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹..." oninput="isTyping()">
            <button onclick="doSend()" class="send-btn">ğŸš€</button>
        </div>
    </div>
</div>

<div id="menu-l" class="menu" style="left:0;">
    <center>
        <img id="myImg" src="https://via.placeholder.com/80" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--gold);">
        <h4 id="myN">Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</h4>
        <div id="myLvl" class="level-badge">Lvl 1</div>
        <hr>
        <input type="text" id="nameInp" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯..." style="width:100%; padding:10px; margin-bottom:10px;">
        <button onclick="saveProfile()" style="width:100%; padding:10px; background:var(--gold); border:none;">Ø­ÙØ¸ âœ…</button>
        <br><br>
        <button onclick="clearChat()" id="adminDel" style="display:none; width:100%; padding:10px; background:red; color:white; border:none;">ğŸ—‘ Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Øª Ù„Ù„ÙƒÙ„</button>
        <br><br>
        <button onclick="closeAll()" style="width:100%; padding:10px; background:#333; color:white; border:none;">Ø¥ØºÙ„Ø§Ù‚</button>
    </center>
</div>

<div id="menu-r" class="menu" style="right:0;">
    <h4 style="color:var(--gold)">ğŸ‘¥ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ†</h4>
    <div id="user-list"></div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = { databaseURL: "https://masterchat-f2da9-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let uID = localStorage.getItem('uID') || "U" + Date.now();
    localStorage.setItem('uID', uID);

    let myData = JSON.parse(localStorage.getItem('myData')) || { n: "Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯", img: "https://via.placeholder.com/80", r: "user", xp: 0 };

    // ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø±
    db.ref('banned/'+uID).on('value', s => { if(s.val()) document.getElementById('ban-screen').style.display='flex'; });

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ù„ÙÙ„
    function getLevel(xp) { return Math.floor(xp / 10) + 1; }
    function getRankName(lvl) {
        if(lvl > 50) return "Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© ğŸ–ï¸";
        if(lvl > 20) return "Ù…Ù„Ùƒ ğŸ‘‘";
        if(lvl > 10) return "Ù…ØªÙØ§Ø¹Ù„ Ù…Ø­ØªØ±Ù ğŸ”¥";
        return "Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯";
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    function doSend() {
        let txt = document.getElementById('mInp').value;
        if(!txt.trim()) return;
        
        myData.xp += 1; // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù†Ù‚Ø§Ø·
        let msg = {
            uid: uID, n: myData.n, t: txt, img: myData.img, 
            r: myData.r, xp: myData.xp, 
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        };
        db.ref('msgs').push(msg);
        db.ref('typing/'+uID).remove();
        document.getElementById('mInp').value = "";
        saveData();
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    db.ref('msgs').limitToLast(40).on('value', s => {
        let win = document.getElementById('chat-win');
        win.innerHTML = "";
        s.forEach(child => {
            let d = child.val();
            let lvl = getLevel(d.xp || 0);
            let div = document.createElement('div');
            div.className = `bubble ${d.uid === uID ? 'msg-me' : 'msg-other'}`;
            div.onclick = () => adminAction(child.key, d.uid, d.n);
            
            div.innerHTML = `
                <div style="font-size:10px; margin-bottom:5px;">
                    <span class="level-badge">Lvl ${lvl}</span>
                    <b style="color:${d.r==='admin'?'var(--gold)':'#00d4ff'}">${d.n}</b>
                </div>
                ${d.t ? `<div>${d.t}</div>` : ''}
                ${d.voice ? `<audio src="${d.voice}" controls style="width:200px; height:30px;"></audio>` : ''}
                ${d.imgM ? `<img src="${d.imgM}" style="width:100%; border-radius:10px; margin-top:5px;">` : ''}
                <span class="time">${d.time}</span>
            `;
            win.appendChild(div);
        });
        win.scrollTop = win.scrollHeight;
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù…Ø¨Ø³Ø·)
    let mediaRecorder;
    let audioChunks = [];
    document.getElementById('voiceBtn').onclick = async () => {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            document.getElementById('voiceBtn').style.color = "red";
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                let blob = new Blob(audioChunks, { type: 'audio/mp3' });
                let reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    db.ref('msgs').push({ uid: uID, n: myData.n, voice: reader.result, img: myData.img, xp: myData.xp, time: "ØµÙˆØª ğŸ™ï¸" });
                };
                audioChunks = [];
                document.getElementById('voiceBtn').style.color = "var(--gold)";
            };
        } else {
            mediaRecorder.stop();
        }
    };

    // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
    db.ref('status/'+uID).set({ n: myData.n, online: true });
    db.ref('status').on('child_added', s => {
        let n = s.val().n;
        let notify = document.getElementById('notify');
        notify.innerText = `ğŸ‘‹ Ø¯Ø®Ù„ ${n} Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù…Ù„ÙƒØ©`;
        notify.style.display = 'block';
        setTimeout(() => notify.style.display = 'none', 3000);
    });

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø§Ù„Ùƒ
    let pressTimer;
    document.getElementById('setBtn').onmousedown = () => pressTimer = setTimeout(beAdmin, 3000);
    document.getElementById('setBtn').onmouseup = () => { clearTimeout(pressTimer); openL(); };
    
    function beAdmin() {
        if(prompt("Ø±Ù…Ø² Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±:") === "1234") {
            myData.r = "admin";
            document.getElementById('adminDel').style.display = 'block';
            saveData(); alert("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ù…Ù„ÙƒØ© ğŸ‘‘");
        }
    }

    function adminAction(key, targetUid, name) {
        if(myData.r !== 'admin') return;
        let a = prompt(`1-Ø­Ø°Ù 2-Ø­Ø¸Ø± 3-Ø±ÙØ¹ Ù…Ø´Ø±Ù\nØ§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ: ${name}`);
        if(a=="1") db.ref('msgs/'+key).remove();
        if(a=="2") db.ref('banned/'+targetUid).set(true);
        if(a=="3") db.ref('users_roles/'+targetUid).set('vip');
    }

    function clearChat() { if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ")) db.ref('msgs').remove(); }

    // Ø£Ø³Ø§Ø³ÙŠØ§Øª
    function openL() { closeAll(); document.getElementById('menu-l').classList.add('show'); }
    function openR() { closeAll(); document.getElementById('menu-r').classList.add('show'); }
    function closeAll() { document.querySelectorAll('.menu').forEach(m => m.classList.remove('show')); }
    
    function saveData() {
        localStorage.setItem('myData', JSON.stringify(myData));
        document.getElementById('myN').innerText = myData.n;
        document.getElementById('myLvl').innerText = "Lvl " + getLevel(myData.xp);
    }
    
    function saveProfile() {
        let nn = document.getElementById('nameInp').value;
        if(nn) myData.n = nn;
        saveData(); closeAll();
    }

    function isTyping() { db.ref('typing/'+uID).set(myData.n); setTimeout(()=>db.ref('typing/'+uID).remove(), 3000); }
    db.ref('typing').on('value', s => {
        let t = []; s.forEach(x => { if(x.key !== uID) t.push(x.val()); });
        document.getElementById('typing-st').innerText = t.length ? t.join(',') + " ÙŠÙƒØªØ¨..." : "";
    });

    saveData();
</script>
</body>
</html>
