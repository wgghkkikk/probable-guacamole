<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER RG - CONTROL SYSTEM</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { --royal-blue: #1a2a6c; --danger: #e74c3c; --success: #2ecc71; --gold: #f1c40f; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: #f4f7f6; display: flex; height: 100vh; overflow: hidden; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        #side { width: 260px; background: #fff; border-left: 1px solid #ddd; display: flex; flex-direction: column; z-index: 10; }
        .u-card { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.3s; }
        .u-card:hover { background: #f9f9f9; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        #main { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { padding: 15px; background: var(--royal-blue); color: #fff; display: flex; justify-content: space-between; align-items: center; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        /* ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 12px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); align-self: flex-start; }
        .msg.owner { border-right: 5px solid var(--danger); background: #fff5f5; }
        .rank-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; margin-bottom: 4px; display: inline-block; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­ÙƒÙ… (Popup) */
        #admin-menu { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; z-index: 1000; width: 280px; text-align: center;
        }
        .admin-btn { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #fff; }

        .input-area { padding: 15px; background: #fff; display: flex; gap: 10px; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; }
        button#send { background: var(--royal-blue); color: #fff; border: none; padding: 0 20px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div id="side">
    <div style="padding:15px; font-weight:900; background:#eee;">Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù† ğŸ‘¥</div>
    <div id="uList"></div>
</div>

<div id="main">
    <header>
        <div id="myRankDisplay">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div onclick="location.reload()" style="cursor:pointer;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</div>
    </header>
    <div id="chat"></div>
    <div class="input-area">
        <input type="text" id="mInp" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
        <button id="send" onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<div id="admin-menu">
    <h3 id="targetName">Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ</h3>
    <button class="admin-btn" style="background:var(--danger)" onclick="takeAction('ban')">Ø·Ø±Ø¯ Ù†Ù‡Ø§Ø¦ÙŠ (Ban)</button>
    <button class="admin-btn" style="background:var(--gold)" onclick="takeAction('mute')">ÙƒØªÙ… (Mute)</button>
    <button class="admin-btn" style="background:var(--success)" onclick="takeAction('promote')">ØªØ±Ù‚ÙŠØ© Ù„Ø£Ø¯Ù…Ù†</button>
    <button class="admin-btn" style="background:#888" onclick="closeAdmin()">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<script>
    const config = { databaseURL: "https://masterchat-f2da9-default-rtdb.firebaseio.com" };
    firebase.initializeApp(config);
    const db = firebase.database();

    let myName = localStorage.getItem('rg_name') || "";
    if(!myName) {
        myName = prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ:");
        if(myName) localStorage.setItem('rg_name', myName); else location.reload();
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±ØªØ¨ØªÙƒ (ØºÙŠØ± Ø§Ø³Ù… "Ù…Ø§Ø³ØªØ±" Ù„Ø§Ø³Ù…Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
    let myRank = (myName === "Ù…Ø§Ø³ØªØ±" || myName === "MASTER RG") ? "ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø§Øª" : "Ø¹Ø¶Ùˆ";
    let isMuted = false;
    let selectedUser = "";

    document.getElementById('myRankDisplay').innerText = myName + " (" + myRank + ")";

    // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ ÙØ­Øµ Ø§Ù„ÙƒØªÙ…
    function send() {
        if(isMuted) return alert("Ø£Ù†Øª Ù…ÙƒØªÙˆÙ… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©!");
        let t = document.getElementById('mInp').value.trim();
        if(!t) return;
        db.ref('shilah_chat').push({ u: myName, t: t, r: myRank });
        document.getElementById('mInp').value = "";
    }

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    db.ref('shilah_chat').limitToLast(40).on('child_added', snap => {
        let m = snap.val();
        let div = document.createElement('div');
        div.className = "msg " + (m.r === "ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø§Øª" ? "owner" : "");
        div.innerHTML = `
            <span class="rank-tag" style="background:${m.r === "ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø§Øª" ? 'red' : '#333'}">${m.r}</span>
            <b style="display:block; font-size:12px;">${m.u}</b>
            <span>${m.t}</span>
        `;
        document.getElementById('chat').appendChild(div);
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
    });

    // 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙˆØ§Ù„ØªØ­ÙƒÙ…
    function startPresence() {
        db.ref('online_pro/'+myName).set({ n: myName, r: myRank });
        db.ref('online_pro/'+myName).onDisconnect().remove();

        // ÙØ­Øµ Ø¥Ø°Ø§ ØªÙ… Ø·Ø±Ø¯Ùƒ Ø£Ùˆ ÙƒØªÙ…Ùƒ
        db.ref('actions/'+myName).on('value', snap => {
            let action = snap.val();
            if(action === 'ban') { alert("ØªÙ… Ø·Ø±Ø¯Ùƒ!"); location.href = "about:blank"; }
            if(action === 'mute') isMuted = true;
            if(action === 'unmute') isMuted = false;
        });

        db.ref('online_pro').on('value', snap => {
            let list = document.getElementById('uList'); list.innerHTML = "";
            snap.forEach(u => {
                let user = u.val();
                let card = document.createElement('div');
                card.className = "u-card";
                card.innerHTML = `<b>${user.n}</b> <br> <small>${user.r}</small>`;
                // ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø§Øª ÙŠÙ‚Ø¯Ø± ÙŠÙØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­ÙƒÙ…
                card.onclick = () => {
                    if(myRank === "ØµØ§Ø­Ø¨ Ø§Ù„Ø´Ø§Øª" && user.n !== myName) {
                        selectedUser = user.n;
                        document.getElementById('targetName').innerText = user.n;
                        document.getElementById('admin-menu').style.display = 'block';
                    }
                };
                list.appendChild(card);
            });
        });
    }

    // 4. ØªÙ†ÙÙŠØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©
    function takeAction(type) {
        if(type === 'ban') db.ref('actions/'+selectedUser).set('ban');
        if(type === 'mute') db.ref('actions/'+selectedUser).set('mute');
        if(type === 'promote') db.ref('online_pro/'+selectedUser+'/r').set('Ø£Ø¯Ù…Ù†');
        closeAdmin();
        alert("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø± Ø¹Ù„Ù‰ " + selectedUser);
    }

    function closeAdmin() { document.getElementById('admin-menu').style.display = 'none'; }

    startPresence();
</script>
</body>
</html>
