<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>MASTER RG - PRO EDITION</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --royal: #1a2a6c; --bg: #ffffff; --side: #f8f9fa; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { margin: 0; background: var(--bg); color: #333; height: 100vh; display: flex; overflow: hidden; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†) */
        .sidebar { 
            width: 200px; background: var(--side); border-left: 1px solid #eee; 
            display: flex; flex-direction: column; padding: 15px; flex-shrink: 0;
        }
        .sidebar h4 { font-size: 14px; color: var(--royal); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .user-on { display: flex; align-items: center; gap: 8px; font-size: 13px; margin-bottom: 10px; font-weight: bold; }
        .flag { font-size: 16px; }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; }

        header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .logo { font-size: 20px; font-weight: 900; color: var(--royal); cursor: pointer; }

        .rooms-bar { display: flex; overflow-x: auto; padding: 10px; gap: 8px; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .r-btn { padding: 5px 12px; border: none; background: #eee; border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .r-btn.active { background: var(--royal); color: #fff; }

        #chatBox { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
        .message { margin-bottom: 15px; border-bottom: 1px solid #f9f9f9; padding-bottom: 8px; }
        .u-info { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
        .u-name { font-weight: 700; color: var(--royal); font-size: 13px; }
        .msg-text { font-size: 15px; line-height: 1.5; color: #444; }

        .quote { background: #f1f1f1; padding: 5px 10px; border-right: 3px solid #ccc; font-size: 11px; margin-bottom: 5px; border-radius: 4px; }

        .input-area { padding: 15px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: #fff; }
        #mInput { flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 10px; outline: none; }
        .send-btn { background: var(--royal); color: #fff; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; }

        #repView { display: none; padding: 5px 15px; background: #eee; font-size: 11px; }

        @media (max-width: 600px) {
            .sidebar { width: 120px; padding: 10px; }
            .u-name { font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h4>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† ğŸŒ</h4>
    <div id="userList"></div>
</div>

<div class="main-content">
    <header>
        <div class="logo" onclick="location.reload()">MASTER RG ğŸ‘‘</div>
        <div id="status" style="font-size: 10px; color: green;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„..</div>
    </header>

    <div class="rooms-bar">
        <button class="r-btn active" onclick="changeRoom('main', this)">Ø§Ù„Ø¹Ø±Ø´</button>
        <button class="r-btn" onclick="changeRoom('vip', this)">Ø§Ù„Ø¯ÙŠÙˆØ§Ù†</button>
        <button class="r-btn" onclick="changeRoom('game', this)">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</button>
        <button class="r-btn" onclick="changeRoom('elite', this)">Ø§Ù„Ù†Ø®Ø¨Ø©</button>
    </div>

    <div id="chatBox"></div>

    <div id="repView">
        Ø±Ø¯ Ø¹Ù„Ù‰: <span id="repU"></span> <button onclick="cancelRep()" style="border:none; background:none; color:red; float:left;">âœ•</button>
    </div>

    <div class="input-area">
        <input type="text" id="mInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
        <button onclick="send()" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<script>
    // Firebase Config
    const config = { databaseURL: "https://masterchat-f2da9-default-rtdb.firebaseio.com" };
    firebase.initializeApp(config);
    const db = firebase.database();

    let my = { 
        n: localStorage.getItem('rg_n') || "", 
        f: "ğŸŒ",
        p: "https://ui-avatars.com/api/?name=User"
    };

    // ÙƒØ´Ù Ø§Ù„Ø¯ÙˆÙ„Ø© ÙˆØ§Ù„Ø¹Ù„Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    fetch('https://ipapi.co/json/').then(res => res.json()).then(data => {
        if(data.country_code) {
            my.f = String.fromCodePoint(...data.country_code.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0)));
        }
        if(my.n) updatePresence();
    });

    if(!my.n) {
        let name = prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ù„ÙƒÙŠ:");
        if(name) { localStorage.setItem('rg_n', name); my.n = name; location.reload(); }
    }

    let curRoom = "main", reply = null;

    function changeRoom(id, btn) {
        curRoom = id;
        document.querySelectorAll('.r-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        load();
    }

    function send() {
        let t = document.getElementById('mInput').value.trim();
        if(!t) return;
        db.ref('rooms/'+curRoom).push({ u: my.n, t: t, f: my.f, rep: reply });
        
        // Ø¨ÙˆØª Ø§Ù„ÙØ²Ø¹Ø©
        const brain = { "Ù‡Ù„Ùˆ": "Ù‡Ù„Ø§ ÙˆØºÙ„Ø§ Ø¨Ù†ÙˆØ± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© ğŸ‘‘", "Ø´Ù„ÙˆÙ†Ùƒ": "Ø¨Ø®ÙŠØ± ÙŠØ§ Ø°Ù‡Ø¨ØŒ Ø£Ù†Øª Ø´Ù„ÙˆÙ†ÙƒØŸ", "Ù…Ù†ÙˆØ±": "Ù†ÙˆØ±Ùƒ Ø¹Ø§ÙƒØ³ ÙŠØ§ Ù…Ù„Ùƒ ğŸŒ¹" };
        for(let k in brain) { if(t.includes(k)) { setTimeout(()=> db.ref('rooms/'+curRoom).push({ u: "ğŸ¤– BOT", t: brain[k], bot: true, f: "ğŸ¤–" }), 700); break; } }
        
        cancelRep();
        document.getElementById('mInput').value = "";
    }

    function load() {
        db.ref('rooms/'+curRoom).off();
        const box = document.getElementById('chatBox'); box.innerHTML = "";
        db.ref('rooms/'+curRoom).limitToLast(40).on('child_added', snap => {
            let m = snap.val();
            let div = document.createElement('div');
            div.className = "message";
            div.innerHTML = `
                <div class="u-info" onclick="setRep('${m.u}','${m.t}')">
                    <span class="flag">${m.f || 'ğŸŒ'}</span>
                    <span class="u-name">${m.u}</span>
                    ${m.u === my.n ? `<span style="color:red; font-size:10px; margin-right:auto; cursor:pointer;" onclick="db.ref('rooms/${curRoom}/${snap.key}').remove()">Ø­Ø°Ù</span>` : ''}
                </div>
                <div class="msg-text" onclick="setRep('${m.u}','${m.t}')">
                    ${m.rep ? `<div class="quote"><b>${m.rep.u}:</b> ${m.rep.t}</div>` : ''}
                    ${m.t}
                </div>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        });
    }

    function setRep(u, t) {
        reply = { u, t };
        document.getElementById('repU').innerText = u;
        document.getElementById('repView').style.display = 'block';
    }
    function cancelRep() { reply = null; document.getElementById('repView').style.display = 'none'; }

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙˆÙƒØ´Ù Ø§Ù„Ø¯ÙˆÙ„
    function updatePresence() {
        db.ref('online/'+my.n).set({ n: my.n, f: my.f });
        db.ref('online/'+my.n).onDisconnect().remove();
        db.ref('online').on('value', snap => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            let count = 0;
            snap.forEach(u => {
                count++;
                let user = u.val();
                list.innerHTML += `<div class="user-on"><span>${user.f}</span> ${user.n}</div>`;
            });
            document.getElementById('status').innerText = count + " Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†";
        });
    }

    load();
</script>
</body>
</html>
